#!/bin/bash
set -e

save_logs() {
    echo "save logs"

    pushd diego-lite/diego-lite-pipeline/02_test
        vagrant ssh -c "sudo tar -czf /vagrant/vagrant_upstart_logs.tgz /var/log/upstart"
    popd

    mv diego-lite/diego-lite-pipeline/02_test/vagrant_upstart_logs.tgz .
}

cleanup_vagrant() {
    echo "cleaning up vagrant"

    pushd diego-lite/diego-lite-pipeline/02_test
        vagrant destroy --force
    popd

    vagrant box remove --force diego-lite-in-progress
}

cleanup(){
    set +e
    save_logs
    cleanup_vagrant
}

trap cleanup EXIT

vagrant box add diego-lite.box --name diego-lite-in-progress

pushd diego-lite/diego-lite-pipeline/02_test
    vagrant up  --provider=virtualbox
popd

export DIEGO_RELEASE_PATH=$1
export GOPATH=$DIEGO_RELEASE_PATH

rm -rf $GOPATH/pkg/*

mkdir -p $GOPATH/src/github.com/pivotal-cf-experimental

ln -sf `pwd`/whetstone $GOPATH/src/github.com/pivotal-cf-experimental/

go get github.com/onsi/ginkgo/ginkgo
go get github.com/onsi/gomega

PATH=$PATH:$GOPATH/bin ginkgo -noColor $GOPATH/src/github.com/pivotal-cf-experimental/whetstone -- -domain="192.168.11.11.xip.io" -loggregatorAddress="loggregator.192.168.11.11.xip.io" -receptorAddress="receptor.192.168.11.11.xip.io" -timeout=300
