#!/bin/bash
set -e

pushd diego-release/loggregator
   git fetch
   git checkout origin/master
   git submodule update --init --recursive
popd


VAGRANT_BOX_NAME_OR_PATH=$1

if [ -z "$1" ]; then
    VAGRANT_BOX_NAME_OR_PATH="ubuntu/trusty64"
fi

if [ -n "$2" ]; then
    echo "Setting Virtualbox machine folder to $2/virtualbox_vms"
    vboxmanage setproperty machinefolder $2/virtualbox_vms #/var/vcap/data/virtualbox_vms on gocd

    mkdir -p $2/vagrant_home
fi

rm -f Vagrantfile
vagrant init $VAGRANT_BOX_NAME_OR_PATH --minimal
vagrant up --provider=virtualbox

set +e

vagrant ssh -c "/vagrant/diego-lite/scripts/ci/install_on_vagrant"
INSTALL_ON_VAGRANT_EXIT_CODE=$?

set -e

if [ "$INSTALL_ON_VAGRANT_EXIT_CODE" -eq "0" ]; then
    rm -f diego-lite.box
    vagrant package --output diego-lite.box
fi

vagrant destroy -f

exit $INSTALL_ON_VAGRANT_EXIT_CODE
