#!/bin/bash
set -e

./update-diego-release

VAGRANT_BOX_NAME_OR_PATH=$1

if [ -z "$1" ]; then
    VAGRANT_BOX_NAME_OR_PATH="ubuntu/trusty64"
fi

if [ -n "$2" ]; then
    echo "Setting Virtualbox machine folder to $2/virtualbox_vms"
    vboxmanage setproperty machinefolder $2/virtualbox_vms #/var/vcap/data/virtualbox_vms on gocd

    mkdir -p $2/vagrant_home
    export VAGRANT_HOME=$2/vagrant_home
fi

rm -f Vagrantfile
vagrant init $VAGRANT_BOX_NAME_OR_PATH --minimal
vagrant up --provider=virtualbox

vagrant ssh -c "/vagrant/diego-lite/scripts/ci/install_on_vagrant"

vagrant package --output diego-lite.box
